#!./phantomjs --ssl-protocol=any --ignore-ssl-errors=true --web-security=false
'use strict';
var system = require('system');
var _ = require('lodash');
var webpage = require('webpage');

console.log(system.args);
var url = system.args[1];

var page = webpage.create();
page.settings.loadImages = false;
page.settings.userAgent = 'Mozilla/5.0 (Windows NT 6.1; rv:31.0) Gecko/20100101 Firefox/31.0';

page.onConsoleMessage = function(msg) {
  console.log('> ' + msg);
};

page.open(url, function(status) {
  var swagger = scrapePage();

  if (_.isUndefined(swagger))
    phantom.exit(255);
  console.log(swagger);
  phantom.exit(0);
});

function scrapePage() {
  var swagger = scrapeSwaggerUi();

  for (var i = 0; i < page.framesCount; ++i) {
    page.switchToChildFrame(i);
    var result = scrapeSwaggerUi();
    page.switchToParentFrame();

    if (result) {
      if (swagger)
        console.log('duplicate');
      swagger = result;
    }
  }
  return swagger;
}

function scrapeSwaggerUi() {
  return page.evaluate(function() {
    if (!window.swaggerUi) {
      console.log('missing swaggerUi');
      return;
    }
    var options = window.swaggerUi.options;
    console.log('options:' + options);
    return options.url || options.discoveryUrl;
  });
}
